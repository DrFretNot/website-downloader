---
import Layout from '../layouts/Layout.astro';

const pageTitle = 'SiteDowner - Download webpages and convert them to Markdown format';
const pageDescription = 'A simple, efficient, and free online tool that helps you easily extract webpage content and convert it to a neat Markdown format, saving you time and effort.';
const keywords = 'website download,HTML to Markdown,web archiving,offline reading,content scraping';
---

<Layout title={pageTitle} description={pageDescription} keywords={keywords}>
      <main class="container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-6 gap-8 mt-8">
            <!-- 左侧面板：下载选项 -->
            <!-- Left Panel: Download Options -->
            <div id="download" class="col-span-4 space-y-8">
                <div class="">
                    <!-- URL输入卡片 -->
                    <!-- URL Input Card -->
                    <div class="col-span-3 bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 fade-in">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-link text-primary-500 mr-3"></i>
                            Website Download
                        </h2>
                        
                        <div class="mb-6">
                            <label class="text-md font-semibold block text-gray-700 dark:text-gray-300 mb-3">Download Options</label>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="flex items-center justify-center download-option checked border-2 border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center cursor-pointer" data-option="single">
                                    <i class="fas fa-file-alt text-2xl text-primary-500 mr-2"></i>
                                    <p class="font-medium">Single Page</p>
                                </div>
                                <div class="flex items-center justify-center download-option border-2 border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center cursor-pointer" data-option="site">
                                    <i class="fas fa-globe text-2xl text-primary-500 mr-2"></i>
                                    <p class="font-medium">Whole Site</p>
                                </div>
                                <div class="flex items-center justify-center download-option border-2 border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center cursor-pointer" data-option="batch">
                                    <i class="fas fa-list text-2xl text-primary-500 mr-2"></i>
                                    <p class="font-medium">Batch URLs</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Single/Site URL Input -->
                        <div id="single-url-input" class="mb-6">
                            <label for="website-url" class="text-md font-semibold block text-gray-700 dark:text-gray-300">Website URL</label>
                            <div class="flex mt-3">
                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-400 text-sm">
                                    https://
                                </span>
                                <input type="text" id="website-url" class="border flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500" placeholder="example.com">
                            </div>
                        </div>
                        
                        <!-- Batch URLs Input -->
                        <div id="batch-urls-input" class="mb-6 hidden">
                            <label for="batch-urls" class="text-md font-semibold block text-gray-700 dark:text-gray-300 mb-2">
                                Multiple URLs (one per line, up to 50)
                            </label>
                            <textarea 
                                id="batch-urls" 
                                rows="8" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-primary-500 focus:border-primary-500 font-mono text-sm" 
                                placeholder="https://example.com/page1&#10;https://example.com/page2&#10;https://another-site.com/article&#10;..."></textarea>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                                Enter one URL per line. URLs can be from different websites.
                            </p>
                        </div>
                        
                        <!-- Progress Bar (for batch downloads) -->
                        <div id="batch-progress" class="mb-4 hidden">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Download Progress</span>
                                <span id="progress-text" class="text-sm text-gray-500 dark:text-gray-400">0 / 0</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div id="progress-bar" class="bg-primary-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>

                        <button id="downloadBtn" class="w-48 bg-primary-500 hover:bg-primary-600 text-white py-3 px-4 rounded-lg font-medium transition-colors flex items-center justify-center cursor-pointer ml-auto">
                            <i class="fas fa-download mr-2"></i>
                            Start Download
                        </button>
                    </div>
                </div>
                
                
                <!-- 已下载文件卡片 -->
                <!-- Downloaded Files Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-50 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-folder-open text-primary-500 mr-3"></i>
                            Downloaded Files
                        </h2>
                        Downloaded: <span id="downloadCount" class="text-sm text-gray-500 dark:text-gray-400">0</span>
                    </div>
                    
                    <div id="fileList" class="empty-state rounded-lg p-8 text-center">
                        <i class="fas fa-inbox text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400">No downloaded files</p>
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Downloaded files will be displayed here</p>
                    </div>

                    <!-- 文件操作 -->
                    <!-- File Operations -->
                    <div id="convert" class="bg-white dark:bg-gray-800 fade-in">
                        <label class="text-md font-semibold block text-gray-700 dark:text-gray-300 mt-6 mb-2">
                            File Operations
                        </label>
                        <div class="flex items-center gap-4">
                            <button id="convertAllBtn" class="w-full bg-gray-400/80 hover:bg-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white py-3 px-4 rounded-lg font-medium transition-colors flex items-center justify-center cursor-pointer">
                                <i class="fa-solid fa-bars-staggered mr-2"></i>
                                Convert to Markdown
                            </button>
                            <button id="saveAllBtn" class="w-full flex items-center justify-center py-3 px-4 bg-primary-500/80 hover:bg-primary-500 dark:bg-primary-600/80 dark:hover:bg-primary-600 rounded-lg font-medium transition-colors cursor-pointer">
                                <i class="fas fa-download text-primary-700 mr-3"></i>
                                <span>Save Files</span>
                            </button>
                            <button id="clearAllBtn" class="w-full bg-red-400/80 hover:bg-red-400 dark:bg-red-300/80 dark:hover:bg-red-300 text-red-600 dark:text-white py-3 px-4 rounded-lg font-medium transition-colors flex items-center justify-center cursor-pointer">
                                <i class="fas fa-trash-alt mr-2"></i>
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧面板：URL输入和转换选项 -->
            <!-- Right Panel: URL Input and Conversion Options -->
            <div class="col-span-2 space-y-8">
                <!-- 功能特性 -->
                <!-- Features -->
                <div id="features" class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 fade-in">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                        <i class="fas fa-star text-primary-500 mr-3"></i>
                        Features
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="bg-primary-100 dark:bg-primary-900/30 rounded-lg p-2 mr-4">
                                <i class="fas fa-bolt text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Fast Download</h3>
                                <p class="text-gray-600 dark:text-gray-400">Efficiently download web content, saving you time</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="bg-primary-100 dark:bg-primary-900/30 rounded-lg p-2 mr-4">
                                <i class="fas fa-shield-alt text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Privacy Protection</h3>
                                <p class="text-gray-600 dark:text-gray-400">All processing is done locally, protecting your privacy</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="bg-primary-100 dark:bg-primary-900/30 rounded-lg p-2 mr-4">
                                <i class="fas fa-file-code text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Format Preservation</h3>
                                <p class="text-gray-600 dark:text-gray-400">Accurately convert formats, preserving original layout</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    // Handle download option selection
    const downloadOptions = document.querySelectorAll('.download-option');
    const singleUrlInput = document.getElementById('single-url-input');
    const batchUrlsInput = document.getElementById('batch-urls-input');
    const batchProgress = document.getElementById('batch-progress');
    
    downloadOptions.forEach(option => {
        option.addEventListener('click', () => {
            downloadOptions.forEach(opt => opt.classList.remove('checked'));
            option.classList.add('checked');
            
            const selectedOption = option.getAttribute('data-option');
            
            // Show/hide appropriate inputs
            if (selectedOption === 'batch') {
                singleUrlInput.classList.add('hidden');
                batchUrlsInput.classList.remove('hidden');
            } else {
                singleUrlInput.classList.remove('hidden');
                batchUrlsInput.classList.add('hidden');
                batchProgress.classList.add('hidden');
            }
        });
    });

// 初始化IndexedDB
// Initialize IndexedDB
const initDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('WebsiteDownloaderDB', 1);
    
    request.onupgradeneeded = (event: any) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('downloadedFiles')) {
        db.createObjectStore('downloadedFiles', { keyPath: 'id', autoIncrement: true });
      }
    };
    
    request.onsuccess = (event: any) => {
      resolve(event.target.result);
    };
    
    request.onerror = (event) => {
      reject('Failed to initialize IndexedDB');
    };
  });
};

// 清空IndexedDB
// Clear IndexedDB
const clearDB = async () => {
  const db = await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['downloadedFiles'], 'readwrite');
    const store = transaction.objectStore('downloadedFiles');
    const request = store.clear();
    
    request.onsuccess = () => {
      resolve();
    };
    
    request.onerror = (event) => {
      reject('Failed to clear database');
    };
  });
};

// 保存文件到IndexedDB
// Save file to IndexedDB
const saveToDB = async (url: any, content: any) => {
  const db = await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['downloadedFiles'], 'readwrite');
    const store = transaction.objectStore('downloadedFiles');
    
    const urlObj = new URL(url);
    const pathParts = urlObj.pathname.split('/').filter(part => part);
    let filename = pathParts.length > 0 ? pathParts[pathParts.length - 1] : 'index.html';
    if (!filename.includes('.')) {
      filename += '.html';
    }
    
    const fileData = {
      url: url,
      filename: filename,
      content: content,
      timestamp: new Date().toISOString()
    };
    
    const request = store.add(fileData);
    
    request.onsuccess = () => {
      resolve();
      // Update file list asynchronously (don't block)
      updateFileList().catch(err => console.error('Failed to update file list:', err));
    };
    
    request.onerror = () => {
      // 保存到数据库失败
      // Failed to save to database
      reject('保存到数据库失败');
    };
  });
};

// 更新文件列表显示
// Update file list display
const updateFileList = async () => {
  const db = await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['downloadedFiles'], 'readonly');
    const store = transaction.objectStore('downloadedFiles');
    const request = store.getAll();
    
    request.onsuccess = (event) => {
      const files = event.target.result;
      const htmlFiles = files.filter(file => file.filename.endsWith('.html'));
      
      if (files.length === 0) {
        fileListElement.innerHTML = '<p class="text-gray-500">No downloaded files yet</p>';
        return;
      }
      
      // 更新HTML文件计数
      // Update HTML file count
      document.getElementById('downloadCount').textContent = htmlFiles.length;
      
      fileListElement.innerHTML = files.map(file => `
        <div class="border-b border-gray-200 pb-2">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <div class="flex items-center">
                <input type="checkbox" class="file-checkbox mr-2" data-id="${file.id}" checked>
                <span>${file.filename}</span>
              </div>
              <a href="${file.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-600 hover:underline">${file.url}</a>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-500">${new Date(file.timestamp).toLocaleString()}</span>
              <button class="text-red-500 hover:text-red-700 delete-btn" data-id="${file.id}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');
      
      resolve();
    };
    
    request.onerror = () => {
      // 获取文件列表失败
      // Failed to get file list
      reject('获取文件列表失败');
    };
  });
};


// 更新文件列表显示
// Check if file exists
const checkExist = async (url: any) => {
  const db = await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['downloadedFiles'], 'readonly');
    const store = transaction.objectStore('downloadedFiles');
    const request = store.getAll();
    
    request.onsuccess = (event: any) => {
      const files = event.target.result;
      const exFiles = files.filter((file: any) => file.url === url);
      
      resolve(exFiles.length!== 0);
    };
    
    request.onerror = () => {
      // 失败
      // Failed
      reject('失败');
    };
  });
};

// 递归下载页面及其链接
// Recursively download page and its links
const crawlPage = async (url: any, visitedUrls = new Set(), depth = 0, maxDepth = 1, downloadedCount = 0, retryCount = 0) => {
  // 检查URL是否已存在于数据库中
  // Check if URL already exists in database

  // 检查URL是否已存在
  // Check if URL already exists
  // Check if URL already exists
  const exists = await checkExist(url);
  // console.log('检查结果:', exists); // 打印检查结果
  console.log('Check result:', exists); // Print check result
  if (exists) {
    // console.log(`URL ${url} 已存在，跳过下载`);
    console.log(`URL ${url} already exists, skipping download`);
    return;
  }
  
  if (visitedUrls.has(url) || depth > maxDepth || downloadedCount >= 5) {
    if (downloadedCount >= 5) {
      // 已达到最大下载数量5个页面
      // Reached maximum download limit of 5 pages
      alert('Reached maximum download limit of 5 pages');
    }
    return;
  }
  
  visitedUrls.add(url);
  // console.log(`正在下载: ${url}`);
  console.log(`Downloading: ${url}`);

  try {
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const response = await fetch(proxyUrl);
    // HTTP错误
    // HTTP error
    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
    
    const data = await response.json();
    // 无法获取网页内容
    // Unable to get webpage content
    if (!data.contents) throw new Error('Unable to get webpage content');
    
    // 重置重试计数器
    // Reset retry counter
    retryCount = 0;
    
    // 保存当前页面
    // Save current page
    await saveToDB(url, data.contents);
    downloadedCount++;
    document.getElementById('downloadCount').textContent = downloadedCount;
    
    if (downloadedCount >= 5) {
      // 已达到最大下载数量5个页面
      // Reached maximum download limit of 5 pages
      alert('Reached maximum download limit of 5 pages');
      return;
    }
    
    // 解析HTML提取链接
    // Parse HTML to extract links
    const parser = new DOMParser();
    const doc = parser.parseFromString(data.contents, 'text/html');
    const links = Array.from(doc.querySelectorAll('a[href]'));
    
    // 过滤并处理相对链接
    // Filter and process relative links
    const baseUrl = new URL(url);
    // console.log('当前页面URL:', baseUrl); // 打印当前页面URL
    console.log('Current page URL:', baseUrl); // Print current page URL
    const pageLinks = links
      .map(link => {
        try {
          // console.log('原始链接:', link.pathname); // 打印原始链接
          console.log('Original link:', link.pathname); // Print original link
          return url + link.pathname;
        } catch {
          return null;
        }
      })
      // .filter(href => href && href.startsWith(baseUrl.origin));
    
    // 递归下载链接页面
    // Recursively download linked pages
    for (const link of pageLinks) {
      // console.log('处理后的链接:', link); // 打印处理后的链接
      console.log('Processed link:', link); // Print processed link
      await crawlPage(link, visitedUrls, depth + 1, maxDepth, downloadedCount);
    }
  } catch (error) {
    // console.error(`下载页面 ${url} 失败:`, error);
    console.error(`Failed to download page ${url}:`, error);
    
    // 重试逻辑
    // Retry logic
    if (retryCount < 3) {
      retryCount++;
      // console.log(`下载失败，将在3秒后重试(第${retryCount}次)`);
      console.log(`Download failed, will retry in 3 seconds (attempt ${retryCount})`);
      await new Promise(resolve => setTimeout(resolve, 3000));
      return crawlPage(url, visitedUrls, depth, maxDepth, downloadedCount, retryCount);
    } else {
      // console.error(`页面 ${url} 下载失败，已达到最大重试次数`);
      console.error(`Page ${url} download failed, reached maximum retry count`);
    }
  }
};

function removeTrailingSlash(url: any) {
  if (!url) {
    return;
  }
    try {
        const urlObj = new URL(url);
        // 处理路径末尾斜杠
        // Handle trailing slashes in path
        urlObj.pathname = urlObj.pathname.replace(/\/+$/, '');
        // 根路径特殊处理
        // Special handling for root path
        if (urlObj.pathname === '' && urlObj.search === '' && urlObj.hash === '') {
            return urlObj.origin;
        }
        return urlObj.toString();
    } catch (e) {
        // 处理无效URL或相对路径（谨慎使用）
        // Handle invalid URL or relative path (use with caution)
        return url.replace(/\/+$/, '');
    }
}

// Parse URLs from textarea input
function parseBatchUrls(text: string): string[] {
  const lines = text.split('\n')
    .map(line => line.trim())
    .filter(line => line.length > 0);
  
  const urls: string[] = [];
  for (const line of lines) {
    try {
      // Try to create URL object to validate
      let url = line;
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }
      const urlObj = new URL(url);
      urls.push(removeTrailingSlash(urlObj.toString()));
    } catch (e) {
      console.warn(`Invalid URL skipped: ${line}`);
    }
  }
  
  return urls;
}

// Download a single URL (used by batch download)
async function downloadSingleUrl(url: string): Promise<{ success: boolean; error?: string }> {
  try {
    // Check if URL already exists
    const exists = await checkExist(url);
    if (exists) {
      return { success: false, error: 'Already exists' };
    }
    
    // Normalize URL
    let normalizedUrl = url;
    if (!normalizedUrl.startsWith('http://') && !normalizedUrl.startsWith('https://')) {
      normalizedUrl = 'https://' + normalizedUrl;
    }
    normalizedUrl = removeTrailingSlash(normalizedUrl);
    
    // Fetch via proxy
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(normalizedUrl)}`;
    const response = await fetch(proxyUrl);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    if (!data.contents) {
      throw new Error('No content received');
    }
    
    // Save to database
    await saveToDB(normalizedUrl, data.contents);
    return { success: true };
  } catch (error: any) {
    return { success: false, error: error.message || 'Unknown error' };
  }
}

// Batch download function
async function downloadBatchUrls(urls: string[], btn: any) {
  const maxUrls = 50; // Limit to 50 URLs
  const urlsToDownload = urls.slice(0, maxUrls);
  
  if (urls.length > maxUrls) {
    alert(`Too many URLs. Only the first ${maxUrls} will be downloaded.`);
  }
  
  if (urlsToDownload.length === 0) {
    alert('No valid URLs found. Please enter at least one URL.');
    return;
  }
  
  // Show progress bar
  batchProgress.classList.remove('hidden');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = 'Downloading...';
  
  let successCount = 0;
  let failCount = 0;
  const failedUrls: string[] = [];
  
  // Download URLs sequentially to avoid overwhelming the proxy
  for (let i = 0; i < urlsToDownload.length; i++) {
    const url = urlsToDownload[i];
    
    // Download with retry
    let retries = 3;
    let result = { success: false, error: '' };
    
    while (retries > 0 && !result.success) {
      result = await downloadSingleUrl(url);
      if (!result.success && retries > 1) {
        await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds before retry
      }
      retries--;
    }
    
    if (result.success) {
      successCount++;
    } else {
      failCount++;
      failedUrls.push(url);
      console.error(`Failed to download: ${url} - ${result.error}`);
    }
    
    // Update progress AFTER download completes
    const progress = ((i + 1) / urlsToDownload.length) * 100;
    if (progressBar) progressBar.style.width = `${progress}%`;
    if (progressText) progressText.textContent = `${i + 1} / ${urlsToDownload.length}`;
    
    // Update file list after each successful download
    if (result.success) {
      await updateFileList();
    }
    
    // Small delay between downloads to be respectful to the proxy
    if (i < urlsToDownload.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 500));
    }
  }
  
  // Final update of file list
  await updateFileList();
  
  // Hide progress bar
  batchProgress.classList.add('hidden');
  
  // Restore button
  btn.disabled = false;
  btn.textContent = originalText;
  
  // Show results
  let message = `Download complete!\n\nSuccess: ${successCount}\nFailed: ${failCount}`;
  if (failedUrls.length > 0 && failedUrls.length <= 10) {
    message += `\n\nFailed URLs:\n${failedUrls.join('\n')}`;
  } else if (failedUrls.length > 10) {
    message += `\n\n${failedUrls.length} URLs failed (check console for details)`;
  }
  alert(message);
}

async function handleDownload(btn: any, retryCount = 1) {
  // Get selected download option
  const selectedOption = document.querySelector('.download-option.checked')?.getAttribute('data-option');
  
  // Handle batch download
  if (selectedOption === 'batch') {
    const batchUrlsTextarea = document.getElementById('batch-urls') as HTMLTextAreaElement;
    const urlsText = batchUrlsTextarea?.value.trim() || '';
    
    if (!urlsText) {
      alert('Please enter at least one URL');
      return;
    }
    
    const urls = parseBatchUrls(urlsText);
    if (urls.length === 0) {
      alert('No valid URLs found. Please check your input.');
      return;
    }
    
    await downloadBatchUrls(urls, btn);
    return;
  }
  
  // Handle single page or whole site download
  const urlInput = document.querySelector('input[type="text"]') as HTMLInputElement;
  const url = removeTrailingSlash(urlInput?.value.trim());
  // console.log('输入的URL:', url);
  console.log('Input URL:', url);
  
  if (!url) {
    alert('Please enter a valid URL');
    return;
  }
  
  // 保存URL到localStorage
  // Save URL to localStorage
  localStorage.setItem('lastDownloadedUrl', url);
  
  try {
    // 添加加载状态
    // Add loading state
    const originalText = btn?.textContent;
    // console.log('下载开始:', url, '类型:', selectedOption);
    console.log('Download started:', url, 'type:', selectedOption);
    
    if (selectedOption === 'site') {
      // 整站下载
      // Whole site download
      btn.disabled = true;
      // 下载中...
      // Downloading...
      btn.textContent = 'Downloading...';
      await crawlPage(url);
    } else {
      // 单页下载
      // Single page download
      // 检查URL是否已存在
      // Check if URL already exists
      const exists = await checkExist(url);
      // console.log('检查结果:', exists);
      console.log('Check result:', exists);
      if (exists) {
        // console.log(`URL ${url} 已存在，跳过下载`);
        console.log(`URL ${url} already exists, skipping download`);
        alert('This URL has already been downloaded');
        return;
      }

      btn.disabled = true;
      // 下载中...
      // Downloading...
      btn.textContent = 'Downloading...';

      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
      const response = await fetch(proxyUrl);
      // HTTP错误
    // HTTP error
    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
      
      const data = await response.json();
      if (data.contents) {
        await saveToDB(url, data.contents);
      } else {
        throw new Error('无法获取网页内容');
      }
    }
    
    // 更新文件列表
    // Update file list
    await updateFileList();
    
    // 恢复按钮状态
    // Restore button state
    btn.disabled = false;
    btn.textContent = originalText;
  } catch (error: any) {
    // console.error('下载失败:', error);
    console.error('Download failed:', error);
    if (retryCount < 3) {
      retryCount++;
      // console.log(`下载失败，将在3秒后重试(第${retryCount}次)`);
      console.log(`Download failed, will retry in 3 seconds (attempt ${retryCount})`);
      setTimeout(() => handleDownload(btn, retryCount), 3000);
      return;
    }
    // 下载失败
    // Download failed
    alert(`Download failed: ${error.message}`);
    
    // 确保按钮状态恢复
    // Ensure button state is restored
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Start Download';
    }
  }
}

// 保存选中的文件
// Save selected files
const saveAllFiles = async () => {
  try {
    const db = await initDB();
    const transaction = db.transaction(['downloadedFiles'], 'readonly');
    const store = transaction.objectStore('downloadedFiles');
    const request = store.getAll();
    
    request.onsuccess = async (event) => {
      const files = event.target.result;
      const selectedFiles = files.filter(file => {
        const checkbox = document.querySelector(`.file-checkbox[data-id="${file.id}"]`);
        return checkbox?.checked;
      });
      
      if (selectedFiles.length === 0) {
        // 请至少选择一个文件
        // Please select at least one file
        alert('Please select at least one file');
        return;
      }
      
      // Download files sequentially to avoid browser download limit (typically 10)
      // Browsers limit simultaneous downloads, so we need to space them out
      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        const blob = new Blob([file.content], { type: 'text/html' });
        const downloadUrl = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = file.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Revoke URL after a short delay to ensure download starts
        setTimeout(() => {
          URL.revokeObjectURL(downloadUrl);
        }, 100);
        
        // Add delay between downloads to respect browser limits
        // Wait longer for the first 10 to ensure they start, then shorter delays
        if (i < selectedFiles.length - 1) {
          const delay = i < 10 ? 300 : 200; // Longer delay for first 10 files
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
      
      // 已保存${selectedFiles.length}个文件
      // Saved ${selectedFiles.length} files
      alert(`Saved ${selectedFiles.length} files`);
    };
    
    request.onerror = () => {
      // 获取文件列表失败
      // Failed to get file list
      throw new Error('Failed to get file list');
    };
  } catch (error) {
    // console.error('保存选中的文件失败:', error);
    console.error('Failed to save selected files:', error);
    // 保存选中的文件失败
    // Failed to save selected files
    alert(`Failed to save selected files: ${error.message}`);
  }
};

// 批量转换所有文件为Markdown
// Batch convert all files to Markdown
function convertAllToMarkdown() {
  if (!confirm('Are you sure you want to convert all files to Markdown format?')) {
    return;
  }
  
  (async () => {
    try {
      const db = await initDB();
      const transaction = db.transaction(['downloadedFiles'], 'readwrite');
      const store = transaction.objectStore('downloadedFiles');
      const request = store.getAll();
      
      request.onsuccess = async (event) => {
        const files = event.target.result;
        
        if (files.length === 0) {
          // 没有可转换的文件
          // No files to convert
          alert('No files to convert');
          return;
        }
        
        var convert_size = 0;
        const htmlFiles = files.filter(file => file.filename.endsWith('.html'));
        
        // 只对HTML文件进行转换
        // Only convert HTML files
        for (const file of htmlFiles) {
          await new Promise((resolve, reject) => {
            const getRequest = store.get(file.id);
            
            getRequest.onsuccess = (e) => {
              const f = e.target.result;
              if (!f) {
                resolve(undefined);
                return;
              }
              
              // Check if MD file already exists for this URL
              const mdFilename = f.filename.replace('.html', '.md');
              const existingMd = files.find(existingFile => existingFile.url === f.url && existingFile.filename === mdFilename);
              if (existingMd) {
                // Skip if already converted
                resolve(undefined);
                return;
              }
              
              let markdown = f.content
                .replace(/<h1[^>]*>(.*?)<\/h1>/g, '# $1\n\n')
                .replace(/<h2[^>]*>(.*?)<\/h2>/g, '## $1\n\n')
                .replace(/<h3[^>]*>(.*?)<\/h3>/g, '### $1\n\n')
                .replace(/<p[^>]*>(.*?)<\/p>/g, '$1\n\n')
                .replace(/<a href="([^"]*)"[^>]*>(.*?)<\/a>/g, '[$2]($1)')
                .replace(/<img[^>]*src="([^"]*)"[^>]*>/g, '![]($1)')
                .replace(/<[^>]+>/g, '');
              
              // 创建新的MD文件记录而不是覆盖原文件
              // Create new MD file record instead of overwriting original file
              const mdFile = {
                url: f.url,
                filename: f.filename.replace('.html', '.md'),
                content: markdown,
                timestamp: new Date().toISOString()
              };
              const addRequest = store.add(mdFile);
              addRequest.onsuccess = () => {
                convert_size++;
                resolve(undefined);
              };
              addRequest.onerror = (err) => {
                console.error('Failed to add MD file:', err);
                resolve(undefined);
              };
            };
            
            getRequest.onerror = () => resolve(undefined);
          });
        }
        
        await updateFileList();
        // 已成功转换${convert_size}个文件
        // Successfully converted ${convert_size} files
        alert(`Successfully converted ${convert_size} files`);
      };
      
      request.onerror = () => {
        // 获取文件列表失败
        // Failed to get file list
        throw new Error('Failed to get file list');
      };
    } catch (error) {
      // console.error('批量转换失败:', error);
      console.error('Batch conversion failed:', error);
      // 批量转换失败
      // Batch conversion failed
      alert(`Batch conversion failed: ${error.message}`);
    }
  })();
}

// 清空所有文件
// Clear all files
const clearAllFiles = async () => {
  if (!confirm('Are you sure you want to clear all downloaded files? This cannot be undone!')) {
    return;
  }
  
  try {
    await clearDB();
    updateFileList();
    // 已清空所有文件
    // Cleared all files
    alert('Cleared all files');
  } catch (error) {
    // console.error('清空文件失败:', error);
    console.error('Failed to clear files:', error);
    // 清空文件失败
    // Failed to clear files
    alert(`Failed to clear files: ${error.message}`);
  }
};

// 删除单个文件
// Delete single file
const deleteFile = async (event: any) => {
  event.stopPropagation();
  const target = event.target.closest('.delete-btn');
  if (!target) return;
  
  const fileId = target.getAttribute('data-id');
  
  if (!confirm('Are you sure you want to delete this file?')) {
    return;
  }
  
  try {
    const db = await initDB();
    await new Promise((resolve, reject) => {
      const transaction = db.transaction(['downloadedFiles'], 'readwrite');
      const store = transaction.objectStore('downloadedFiles');
      const request = store.delete(Number(fileId));
      
      request.onsuccess = () => {
        resolve();
        updateFileList();
      };
      
      request.onerror = () => {
        // 删除文件失败
        // Failed to delete file
        reject('Failed to delete file');
      };
    });
  } catch (error) {
    // console.error('删除文件失败:', error);
    console.error('Failed to delete file:', error);
    // 删除文件失败
    // Failed to delete file
    alert(`Failed to delete file: ${error}`);
  }
};

let fileListElement: any;
document.addEventListener('DOMContentLoaded', () => {
  fileListElement = document.getElementById('fileList');
  // 从localStorage恢复URL
  // Restore URL from localStorage
  const lastUrl = localStorage.getItem('lastDownloadedUrl');
  if (lastUrl) {
    const urlInput = document.querySelector('input[type="text"]');
    if (urlInput) {
      urlInput.value = lastUrl;
    }
  }
  
  document.getElementById('downloadBtn')?.addEventListener('click', (e: any) => handleDownload(e.target));
  document.getElementById('saveAllBtn')?.addEventListener('click', saveAllFiles);
  document.getElementById('clearAllBtn')?.addEventListener('click', clearAllFiles);
  document.getElementById('convertAllBtn')?.addEventListener('click', convertAllToMarkdown);
  // 按文件类型选择
  // Select by file type
  document.querySelectorAll('input[name="fileType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const type = e.target.value;
      const checkboxes = document.querySelectorAll('.file-checkbox');
      
      checkboxes.forEach(checkbox => {
        const fileId = checkbox.getAttribute('data-id');
        const fileElement = checkbox.closest('.border-b');
        const filename = fileElement?.querySelector('span')?.textContent || '';
        
        if (type === 'all') {
          checkbox.checked = true;
        } else if (type === 'html') {
          checkbox.checked = filename.endsWith('.html');
        } else if (type === 'md') {
          checkbox.checked = filename.endsWith('.md');
        }
      });
    });
  });
  updateFileList();
  
  // 使用事件委托处理删除按钮点击
  // Use event delegation to handle delete button clicks
  document.getElementById('fileList')?.addEventListener('click', (event) => {
    const deleteBtn = event.target.closest('.delete-btn');
    if (deleteBtn) {
      deleteFile(event);
    }
  });

});

</script>
